{"version":3,"sources":["src/Generators.ts"],"names":[],"mappings":"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","file":"Generators.js","sourcesContent":["'use strict';\n\nimport { launch, LaunchedChrome } from 'chrome-launcher';\nimport * as CDP from 'chrome-remote-interface';\nimport { CreateOptions } from './CreateOptions';\nimport { CreateResult } from './CreateResult';\n\n/**\n * Throws an exception if the operation has been canceled.\n *\n * @param {CreateOptions} options the options which track cancellation.\n * @returns {Promise<void>} reject if canceled, resolve if not.\n */\nasync function throwIfCanceled(options: CreateOptions): Promise<void> {\n  if (options._canceled) {\n    throw new Error('HtmlPdf.create() timed out.');\n  }\n}\n\n/**\n * Launches Chrome with the specified options.\n *\n * @param {CreateOptions} options the options for Chrome.\n * @returns {Promise<LaunchedChrome>} The launched Chrome instance.\n */\nasync function launchChrome(options: CreateOptions): Promise<LaunchedChrome> {\n  const chrome = await launch({\n    port: options.port,\n    chromePath: options.chromePath,\n    chromeFlags: [\n      '--disable-gpu',\n      '--headless',\n      '--hide-scrollbars',\n    ],\n  });\n  options.port = chrome.port;\n  return chrome;\n}\n/**\n * Base class for all Generators.\n */\nexport abstract class Generator {\n  /**\n   * Create a Generator.\n   * @param {string} html The HTML string.\n   * @param {Options} [options] The generation options.\n   */\n  public constructor(public html: string, public options?: CreateOptions) {}\n\n  /**\n   * Generates the document for the generator's instance type\n   *\n   * @returns {Promise<CreateResult>} The generated data.\n   */\n  public async create(): Promise<CreateResult> {\n    const myOptions = Object.assign({}, this.options);\n    let chrome: LaunchedChrome;\n\n    myOptions._canceled = false;\n    if (myOptions.timeout >= 0) {\n      setTimeout(() => {\n        myOptions._canceled = true;\n      }, myOptions.timeout);\n    }\n\n    await throwIfCanceled(myOptions);\n    if (!myOptions.host && !myOptions.port) {\n      await throwIfCanceled(myOptions);\n      chrome = await launchChrome(myOptions);\n    }\n\n    const tab = await CDP.New(myOptions);\n    const client = await CDP({ ...myOptions, tab });\n    try {\n      return await this.generate(client, myOptions);\n    } finally {\n      await client.close();\n      await CDP.Close({ ...myOptions, id: tab.id });\n      if (chrome) {\n        await chrome.kill();\n      }\n    }\n  }\n\n  protected abstract async generate(client: any, options: CreateOptions): Promise<CreateResult>;\n\n  protected get url(): string {\n    return /^(https?|file|data):/i.test(this.html) ? this.html : `data:text/html,${this.html}`;\n  }\n}\n\n/**\n * Generator for PDFs.\n */\nexport class PDFGenerator extends Generator {\n  protected async generate(client: any, options: CreateOptions): Promise<CreateResult> {\n    await throwIfCanceled(options);\n    const {Page} = client;\n    await Page.enable(); // Enable Page events\n    await throwIfCanceled(options);\n    await Page.navigate({url: this.url});\n    await throwIfCanceled(options);\n    await Page.loadEventFired();\n    if (options.completionTrigger) {\n      await throwIfCanceled(options);\n      const waitResult = await options.completionTrigger.wait(client);\n      if (waitResult && waitResult.exceptionDetails) {\n        await throwIfCanceled(options);\n        throw new Error(waitResult.result.value);\n      }\n    }\n    await throwIfCanceled(options);\n    // https://chromedevtools.github.io/debugger-protocol-viewer/tot/Page/#method-printToPDF\n    const base64 = await Page.printToPDF(options.printOptions);\n    await throwIfCanceled(options);\n    return new CreateResult(base64.data);\n  }\n}\n\n/**\n * Generator for screenshots.\n * Code copied from https://github.com/schnerd/chrome-headless-screenshots/blob/master/index.js\n */\nexport class ScreenshotGenerator extends Generator {\n  protected async generate(client: any, options: CreateOptions): Promise<CreateResult> {\n    await throwIfCanceled(options);\n    const {DOM, Emulation, Network, Page} = client;\n\n    await Page.enable();\n    await DOM.enable();\n    await Network.enable();\n\n    await throwIfCanceled(options);\n\n    const deviceMetrics = {\n      width: 1920,\n      height: 1080,\n      deviceScaleFactor: 0,\n      mobile: false,\n      fitWindow: false,\n      ...(options.screenshotOptions && options.screenshotOptions.deviceMetrics),\n    };\n\n    await Emulation.setDeviceMetricsOverride(deviceMetrics);\n    await Emulation.setVisibleSize({\n      width: deviceMetrics.width,\n      height: deviceMetrics.height,\n    });\n    await throwIfCanceled(options);\n\n    await Page.navigate({url: this.url});\n    await throwIfCanceled(options);\n    await Page.loadEventFired();\n\n    if (options.screenshotOptions && options.screenshotOptions.fullPage) {\n      const {root: {nodeId: documentNodeId}} = await DOM.getDocument();\n      const {nodeId: bodyNodeId} = await DOM.querySelector({\n        selector: 'body',\n        nodeId: documentNodeId,\n      });\n      const {model} = await DOM.getBoxModel({nodeId: bodyNodeId});\n      deviceMetrics.height = model.height;\n\n      await Emulation.setVisibleSize({width: deviceMetrics.width, height: deviceMetrics.height});\n      // This forceViewport call ensures that content outside the viewport is\n      // rendered, otherwise it shows up as grey. Possibly a bug?\n      await Emulation.forceViewport({x: 0, y: 0, scale: 1});\n    }\n\n    if (options.completionTrigger) {\n      await throwIfCanceled(options);\n      const waitResult = await options.completionTrigger.wait(client);\n      if (waitResult && waitResult.exceptionDetails) {\n        await throwIfCanceled(options);\n        throw new Error(waitResult.result.value);\n      }\n    }\n    await throwIfCanceled(options);\n\n    const base64 = await Page.captureScreenshot(options.screenshotOptions && options.screenshotOptions.captureScreenShotOptions);\n    await throwIfCanceled(options);\n    return new CreateResult(base64.data);\n  }\n}\n"],"sourceRoot":"../.."}